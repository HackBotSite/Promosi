import dns from "dns";
dns.setDefaultResultOrder("ipv4first");

import fs from "fs";
import path from "path";
import { fileURLToPath } from "url";

const usageCounters = {};

const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);

export async function randomName(req, res) {
  try {
    // --- Load apikeys.json dari folder api ---
    let apikeys = {};
    try {
      const filePath = path.join(__dirname, "..", "api", "apikeys.json");
      apikeys = JSON.parse(fs.readFileSync(filePath, "utf-8"));
    } catch {
      return res.status(500).json({ error: "Config API key tidak ditemukan" });
    }

    // --- Validasi API key ---
    const clientKey = req.headers["x-api-key"] || req.query.apikey;
    if (!clientKey || !apikeys[clientKey]) {
      return res.status(401).json({ error: "API key tidak valid" });
    }

    const { plan = "basic", quota = 100 } = apikeys[clientKey];
    const today = new Date();
    const isoDate = today.toISOString().split("T")[0];
    const usageId = `${clientKey}-${isoDate}`;
    usageCounters[usageId] = (usageCounters[usageId] || 0) + 1;

    if (quota !== "unlimited" && usageCounters[usageId] > quota) {
      return res.status(429).json({
        error: "Quota exceeded",
        tenant: clientKey,
        plan,
        quota,
        used: usageCounters[usageId]
      });
    }

    // --- Load randomname.json dari folder api2 ---
    const filePath = path.join(__dirname, "randomname.json");
    const nameData = JSON.parse(fs.readFileSync(filePath, "utf-8"));

    // --- Fungsi ambil random item dari array ---
    const pickRandom = arr => arr[Math.floor(Math.random() * arr.length)];

    const result = {
      thai_names: [pickRandom(nameData.thai_names)],
      arab_names: [pickRandom(nameData.arab_names)],
      chinese_names: [pickRandom(nameData.chinese_names)],
      european_names: [pickRandom(nameData.european_names)]
    };

    return res.json({
      feature: "Random Name",
      tenant: clientKey,
      plan,
      quota,
      used: usageCounters[usageId],
      date: isoDate,
      status: "success",
      message: "Nama acak berhasil diambil",
      result
    });
  } catch (err) {
    console.error("Internal error random-name:", err);
    return res.status(500).json({ error: "Internal Server Error", detail: err.message });
  }
}
